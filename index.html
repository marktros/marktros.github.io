<html>
<head>
  <script src="node_modules/fetch-intercept/lib/browser.js"></script>
<script>
  !function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","debug","page","once","off","on","addSourceMiddleware","addIntegrationMiddleware","setAnonymousId","addDestinationMiddleware"];analytics.factory=function(e){return function(){var t=Array.prototype.slice.call(arguments);t.unshift(e);analytics.push(t);return analytics}};for(var e=0;e<analytics.methods.length;e++){var key=analytics.methods[e];analytics[key]=analytics.factory(key)}analytics.load=function(key,e){var t=document.createElement("script");t.type="text/javascript";t.async=!0;t.src="https://cdn.segment.com/analytics.js/v1/" + key + "/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(t,n);analytics._loadOptions=e};analytics._writeKey="yrpr9KkcGT5aOANhNDBHFvW0zkxpRH6q";analytics.SNIPPET_VERSION="4.13.2";
  analytics.load("yrpr9KkcGT5aOANhNDBHFvW0zkxpRH6q");
  analytics.page();
  }}();
</script>
<meta http-equiv="content-type" content="text/html; charset=windows-1252">
		<title>Tobi's Garage</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>	
		
</head>
<body>
    <script>
      const orig = XMLHttpRequest.prototype.send;
      XMLHttpRequest.prototype.send = function() { console.log('IN SEND');  return orig.apply(this, arguments); }
      // yea
            //xhr.setRequestHeader('Non-Standad-Header', 'non-standard-value')
    </script>

<p>Testing</p>

<input id="CommitButton" value="Test Event" onclick="formatQs()" type="button" />

<table style="width:100%">
  <tr>
    <td><a href="https://marktros.github.io/?utm_source=Segment&utm_medium=CPC&utm_campaign=Easter_Sale&utm_term=Easter%20Eggs&utm_content=p10001" target="_blank">Test1</a></td>
    <td>{lpurl} or {unescapedlpurl} at start with parameters: </td>
    <td>https://marktros.github.io/?utm_source=Segment&utm_medium=CPC&utm_campaign=Easter_Sale&utm_term=Easter%20Eggs&utm_content=p10001</td>
  </tr>
  <tr>
    <td><a href="https://marktros.github.io?https%3A%2F%2Ftobiordobi.com%2F&utm_source=test2&utm_campaign=decoded_lpurl_back" target="_blank">Test2</a></td>
    <td>{lpurl} encoded at back with parameters</td>
    <td>https://marktros.github.io?https%3A%2F%2Ftobiordobi.com%2F&utm_source=test2&utm_campaign=decoded_lpurl_back</td>
  </tr>
</table>

<script>
  function formatQs(){
    var output = {}; //empty variable array
    var qs = document.location.search.substring(1); //get query string from url
    qs = qs.split('&'); //split at "&"
  
    //loop through each values in the above split and split at "="
    //Store into output array
    for (var i = 0; i < qs.length; i++) {
      var tokens = qs[i].split('=');
      output[tokens[0].toLowerCase()] = tokens[1];
    }
    //Remove object keys with empty values from output array
    //Store as "results"
    var results = Object.fromEntries(Object.entries(output).filter(value => value[1]))
    
    //Segment tracking
    analytics.track("User Referred", { 
      label: "Users",
    },
    {
      context:{
        campaign: {
          source:results.utm_source,
          name:results.utm_campaign,
          medium:results.utm_medium,
          term:results.utm_term,
          content:results.utm_content
        }
      }
    },
      /*
    {
      integrations: {
        All: true,
        GoogleAnalytics: false
      }
    }
      */
    );
  }
  </script>

</body>
</html>
